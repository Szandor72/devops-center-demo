name: validate deployment

on:
    pull_request:
        types: [opened, synchronize, reopened]
        branches:
            - integration
        paths:
            - 'force-app/**'

jobs:
    validate-deployment:
        name: 'Validate Deployment, run local Tests'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: 'Install Salesforce CLI'
              run: |
                  npm install sfdx-cli --location=global
                  sfdx --version

            - name: 'Populate auth file with DEVHUB_SFDX_URL secret'
              run: |
                  echo ${{ secrets.INTEGRATION_SANDBOX_SFDX_URL}} > ./INTEGRATION_SANDBOX_SFDX_URL.auth

            - name: Authenticate against integration sandbox
              run:
                  sfdx force:auth:sfdxurl:store -f ./INTEGRATION_SANDBOX_SFDX_URL.auth -d -a
                  integration_sandbox
            - name: Validate deployment and run local tests
              run:
                  sfdx force source deploy --sourcepath force-app --checkonly --wait 120
                  --testlevel=RunLocalTests -u integration_sandbox
