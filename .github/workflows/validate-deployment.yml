name: validate deployment

on:
    pull_request:
        types: [opened, synchronize, reopened]
        branches:
            - integration
        paths:
            - 'force-app/**'

jobs:
    validate-deployment:
        name: 'Validate Deployment, run local Tests'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
              # Store secret for dev hub
            - name: 'Populate auth file with DEVHUB_SFDX_URL secret'
              run: |
                  echo ${{ secrets.INTEGRATION_SANDBOX_SFDX_URL}} > ./INTEGRATION_SANDBOX_SFDX_URL.auth

            - uses: forcedotcom/salesforcedx-actions@master
              with:
                  args:
                      'sfdx force:auth:sfdxurl:store -f ./INTEGRATION_SANDBOX_SFDX_URL.auth -d -a
                      integration_sandbox'
            - uses: forcedotcom/salesforcedx-actions@master
              with:
                  args: 'sfdx force source deploy --check-only --wait 120 --testlevel=RunLocalTests'
